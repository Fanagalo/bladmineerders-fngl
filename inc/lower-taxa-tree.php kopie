<?php

/**
 * Prints hierarchical tree based on assigned templates.
 * 
 * @since 1.07
 * 
 * @param integer   $depth      Number of levels of the tree
 * @param array     $templates  Finds data in records assigned with a template
 */

function fngl_template_lower_taxa_tree($depth,$templates) {

// 5. Early validation

    if (empty($templates) || $depth < 1) {
        return;
    }

    $current_page = get_the_ID();
    if (!$current_page) {
        return;
    }

// 2.1 Caching
    $cache_key = 'fngl_taxa_tree_' . md5(serialize($templates) . $depth . $current_page);
    $cached_result = get_transient($cache_key);

    if ($cached_result !== false) {
        echo $cached_result;
        return;
    }
// end 2.1 Caching

    global $wpdb;

// 1. SQL call     
// If you know the meta_key, add it to reduce rows scanned
    $sql = "
        SELECT p.ID, p.post_title, p.post_parent, p.menu_order
        FROM $wpdb->posts p
        INNER JOIN $wpdb->postmeta pm ON p.ID = pm.post_id
        WHERE pm.meta_key = '_wp_page_template'
        AND pm.meta_value IN(" . implode(', ', array_fill(0, count($templates), '%s')) . ")
        AND p.post_status = 'publish' could be added, but doubles page generation time
        ORDER BY p.menu_order, p.post_title ASC
        ";


    $query = call_user_func_array(array($wpdb, 'prepare'), array_merge(array($sql), $templates));

    $results = $wpdb->get_results($query);
    if (empty($results)) {
        return;
    }
    
    $children = get_page_children( $current_page, $results );  
    if (empty($children)) {
        return;
    } 

    $r = array( 'walker' => '' );

    $pre_output = '<li class="pagenav">' . get_the_title() . '<ul>';
    $output = walk_page_tree( $children, $depth, $current_page, $r );
    $post_output = '</ul>';
    $final_output = $pre_output . $output . $post_output;

    // Cache for 1 hour
    set_transient($cache_key, $final_output, HOUR_IN_SECONDS);

    echo $final_output;    
}